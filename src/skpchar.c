#include "skp.h"

static uint32_t mask_lower[10] = {
  0x00002000, 0xDE6A0000, 0x9E420000, 0xDE6A0004, 0x00002000, 
  0xDF7E2001, 0x85000000, 0xD7AA2823, 0x21002100, 0xA7086003, 
};

static uint32_t mask_upper[10] = {
  0x00000000, 0x0000DE6A, 0x00008C42, 0x20005E6A, 0x00000000, 
  0x0000DF7E, 0x00008500, 0x38159552, 0x50100040, 0x5014944A, 
};

int skpislowerlatin(uint32_t c,int enc)
{
  if ('a' <= c && c <= 'z') return 1;                   // ASCII
  if (enc == 0) { // UTF-8
    if (0xC39F <= c && c <= 0xC3BF) return  (c != 0xC3B7); // Latin-1
    if (0xC480 <= c && c <= 0xC4B7) return  (c&1);         // Latin-A
    if (0xC4B8 <= c && c <= 0xC588) return !(c&1);         // Latin-A
    if (0xC589 <= c && c <= 0xC5B7) return  (c&1);         // Latin-A
    if (0xC5B9 <= c && c <= 0xC58E) return !(c&1);         // Latin-A
  }
  else {
    _dbgmsg("c:%02X %08X",c,mask_lower[enc-1]);
    if (0xAD == c) return 0; // free 0xAD to signal 0xFF usage
    if (0xFF == c) return (mask_lower[enc-1] & (1<<0x0D));
    if (0xDF <= c && c <= 0xFE) {
      if (enc == 3 && (0xF0 == c || 0xE3 ==c)) return 0;
      if (c == 0xF7) return (mask_lower[enc-1] & 1);
      else return 1;
    }
    if (0xA1 <= c && c <= 0xBF) return !!(mask_lower[enc-1] & (1<<(c-0xA0)));
  }        
  return 0;
}

int skpisupperlatin(uint32_t c,int enc)
{
  if ('A' <= c && c <= 'Z') return 1;                   // ASCII
  if (enc == 0){ // UTF-8
    if (0xC380 <= c && c <= 0xC39E) return (c != 0xC397); // UTF-8 (Latin-1)
    if (0xC480 <= c && c <= 0xC4B7) return !(c&1);        // UTF-8 (Latin-A)
    if (0xC4B8 <= c && c <= 0xC588) return  (c&1);        // UTF-8 (Latin-A)
    if (0xC58A <= c && c <= 0xC5B8) return !(c&1);        // UTF-8 (Latin-A)
    if (0xC5B9 <= c && c <= 0xC58E) return  (c&1);        // UTF-8 (Latin-A)
  }
  else {
    _dbgmsg("c:%02X %08X",c,mask_upper[enc-1]);

    if (0xC0 <= c && c <= 0xDE) {
      if (enc == 3 && (0xD0 == c || 0xC3 ==c) ) return 0;
      if (c == 0xD7) return (mask_lower[enc-1] & 1); // Using mask_lower on purpose!
      else return 1; 
    }

    if (0xA1 <= c && c <= 0xBF)
      return !!(mask_upper[enc-1] & (1UL<<(c-0xA0)));
  }
  return 0;
}

int skpisalphalatin(uint32_t c,int enc)
{
  if (('A' <= c && c <= 'Z') || ('a' <= c && c <= 'z')) return 1;         // ASCII
  if (enc == 0) { // UTF-8
    if (0xC380 <= c && c <= 0xC3BF) return (c != 0xC397 && c != 0xC3B7); // UTF-8 (Latin-1)
    if (0xC480 <= c && c <= 0xC58E) return  1;                           // UTF-8 (Latin-A)
  }
  else {
    if (enc == 3 && (0xF0 == c || 0xE3 ==c || 0xD0 == c || 0xC3 ==c) ) return 0;

    if (0xC0 <= c && c <= 0xFF) 
      return ((c != 0xD7 || (mask_lower[enc-1] & 1)) && (c != 0xF7 || (mask_lower[enc-1] & 1))); 

    if (0xA1 <= c && c <= 0xBF)
      return !!((mask_upper[enc-1] | mask_lower[enc-1] ) & (1UL<<(c-0xA0)));
  }
  return 0;
}

static unsigned char fold_map[10][32] = {
 /* Latin-1 */ { 0xA0,0xA1,0xA2,0xA3,0xA4,0xA5,0xA6,0xA7,0xA8,0xA9,0xAA,0xAB,0xAC,0xAD,0xAE,0xAF,
                 0xB0,0xB1,0xB2,0xB3,0xB4,0xB5,0xB6,0xB7,0xB8,0xB9,0xBB,0xBB,0xBC,0xBD,0xBE,0xBF },
 /* Latin-2 */ { 0xA0,0xB1,0xA2,0xB3,0xA4,0xB5,0xB6,0xA7,0xA8,0xB9,0xBA,0xBB,0xBC,0xAD,0xBE,0xBF,
                 0xB0,0xB1,0xB2,0xB3,0xB4,0xB5,0xB6,0xB7,0xB8,0xB9,0xBB,0xBB,0xBC,0xBD,0xBE,0xBF },
 /* Latin-3 */ { 0xA0,0xB1,0xA2,0xA3,0xA4,0xA5,0xB6,0xA7,0xA8,0xB9,0xBA,0xBB,0xBC,0xAD,0xAE,0xAF,
                 0xB0,0xB1,0xB2,0xB3,0xB4,0xB5,0xB6,0xB7,0xB8,0xB9,0xBB,0xBB,0xBC,0xBD,0xBE,0xBF },
 /* Latin-4 */ { 0xA0,0xB1,0xA2,0xB3,0xA4,0xB5,0xB6,0xA7,0xA8,0xB9,0xBA,0xBB,0xBC,0xAD,0xBE,0xAF,
                 0xB0,0xB1,0xB2,0xB3,0xB4,0xB5,0xB6,0xB7,0xB8,0xB9,0xBB,0xBB,0xBC,0xBF,0xBE,0xBF },
 /* Latin-5 */ { 0xA0,0xA1,0xA2,0xA3,0xA4,0xA5,0xA6,0xA7,0xA8,0xA9,0xAA,0xAB,0xAC,0xAD,0xAE,0xAF,
                 0xB0,0xB1,0xB2,0xB3,0xB4,0xB5,0xB6,0xB7,0xB8,0xB9,0xBB,0xBB,0xBC,0xBD,0xBE,0xBF },
 /* Latin-6 */ { 0xA0,0xB1,0xB2,0xB3,0xB4,0xB5,0xB6,0xA7,0xB8,0xB9,0xBA,0xBB,0xBC,0xAD,0xBE,0xBF,
                 0xB0,0xB1,0xB2,0xB3,0xB4,0xB5,0xB6,0xB7,0xB8,0xB9,0xBB,0xBB,0xBC,0xBD,0xBE,0xBF },
 /* Latin-7 */ { 0xA0,0xA1,0xA2,0xA3,0xA4,0xA5,0xA6,0xA7,0xB8,0xA9,0xBA,0xAB,0xAC,0xAD,0xAE,0xBF,
                 0xB0,0xB1,0xB2,0xB3,0xB4,0xB5,0xB6,0xB7,0xB8,0xB9,0xBB,0xBB,0xBC,0xBD,0xBE,0xBF },
 /* Latin-8 */ { 0xA0,0xA2,0xA2,0xA3,0xA5,0xA5,0xAB,0xA7,0xB8,0xA9,0xBA,0xAB,0xBC,0xAD,0xAE,0xFF,
                 0xB1,0xB1,0xB3,0xB3,0xB5,0xB5,0xB6,0xB9,0xB8,0xB9,0xBF,0xBB,0xBC,0xBE,0xBE,0xBF },
 /* Latin-9 */ { 0xA0,0xA1,0xA2,0xA3,0xA4,0xA5,0xA8,0xA7,0xA8,0xA9,0xAA,0xAB,0xAC,0xAD,0xAE,0xAF,
                 0xB0,0xB1,0xB2,0xB3,0xB8,0xB5,0xB6,0xB7,0xB8,0xB9,0xBB,0xBB,0xBD,0xBD,0xFF,0xBF },
 /* Latin-10*/ { 0xA0,0xA2,0xA2,0xB3,0xA4,0xA5,0xA8,0xA7,0xA8,0xA9,0xBA,0xAB,0xAE,0xAD,0xAE,0xBF,
                 0xB0,0xB1,0xB9,0xB3,0xB8,0xB5,0xB6,0xB7,0xB8,0xB9,0xBB,0xBB,0xBD,0xBD,0xFF,0xBF },
};

uint32_t skpfoldlatin(uint32_t c, int enc)
{
  // int cc = c;  // DEBUG ONLY
  if (skpisupperlatin(c,enc)) {
    if (enc == 0) { // UTF-8
      if (c == 0xC5B8) c = 0xC3BF;   // U+0178 LATIN CAPITAL LETTER Y WITH DIAERESIS
      else if (c < 0xC39E) c += 32;  // 
      else c++;                      // Latin-A
    }
    else { // ISO 8859
      if (0xA1 <= c && c <= 0xBF) c = fold_map[enc-1][c-0xA0];
      else c += 32;
    }
  }
  _dbgmsg("fold: Latin-%d %04X -> %04X",enc,cc,c);
  return c;
}

char *skpnext(char *s, uint32_t *cptr, int enc)
{
  uint32_t chr=0;
 
  chr= *((unsigned char *)s);
  if (*s && (*s++ & 0x80) && (enc==0)) {
    while ((*s & 0xC0) == 0x80) {
      chr = (chr << 8) | *((unsigned char *)s++);
    }
  }
  _dbginf("NXTCHR: %08X",chr);
  if (cptr) *cptr = chr;
  return s;
}
